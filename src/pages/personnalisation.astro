---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Personnalisation - TaVue">
  <div class="bg-base-100">
    <div class="max-w-[1920px] mx-auto">
      <!-- Grille 2 colonnes -->
      <div class="grid grid-cols-2 min-h-screen">
        
        <!-- Colonne gauche : Preview fixe -->
        <div class="bg-base-200 flex flex-col justify-between sticky top-0 h-screen p-12">
          <!-- SVG Preview + Rotation -->
          <div class="flex-1 flex flex-col justify-center items-center">
            <div class="w-full max-w-[480px] mb-8" style="perspective: 1200px;">
              <div id="glassPreview" class="transition-transform duration-500" style="transform-style: preserve-3d;">
                <div id="svgContainer"></div>
              </div>
            </div>

            <!-- Slider rotation -->
            <div class="w-full max-w-[480px]">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-manrope font-medium text-base-content">Rotation</span>
                <span class="text-xs font-manrope font-semibold text-primary"><span id="rotationAngle">0</span>¬∞</span>
              </div>
              <input 
                type="range" 
                min="-180" 
                max="180" 
                value="0"
                step="5"
                class="range range-primary range-sm w-full" 
                id="rotationSlider"
              />
            </div>
          </div>

          <!-- Citation d√©cal√©e en bas -->
          <div class="w-[320px] ml-auto mr-8">
            <p class="font-playfair text-[16px] italic text-base-content/70 leading-relaxed text-right">
              Votre regard,<br/>
              <span class="font-bold text-secondary text-[18px] not-italic">VOTRE CR√âATION</span>
            </p>
          </div>
        </div>

        <!-- Colonne droite : Formulaire -->
        <div class="py-12 px-10">
          <div class="max-w-[560px]">
            
            <!-- Section G√©n√©ration IA -->
            <div class="card bg-gradient-to-br from-primary/10 to-secondary/10 border border-primary/20 shadow-lg mb-8">
              <div class="card-body p-6">
                <div class="flex items-center gap-3 mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  <h2 class="font-playfair text-2xl font-bold text-primary">G√©n√©ration IA</h2>
                </div>
                
                <p class="text-sm text-base-content/70 mb-4 font-manrope">
                  D√©crivez la paire de lunettes de vos r√™ves et l'IA la cr√©era pour vous !
                </p>

                <textarea 
                  id="aiPrompt" 
                  class="textarea textarea-bordered w-full min-h-24 font-manrope text-sm" 
                  placeholder="Ex: Des lunettes rondes vintage en m√©tal dor√© avec des branches fines et √©l√©gantes..."
                ></textarea>

                <div id="aiAlert" class="hidden mt-3"></div>

                <div class="flex gap-3 mt-4">
                  <button id="generateBtn" class="btn btn-primary flex-1 font-manrope">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                    </svg>
                    G√©n√©rer
                  </button>
                  <button id="editBtn" class="btn btn-outline btn-primary font-manrope" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                    Modifier
                  </button>
                </div>
              </div>
            </div>

            <!-- Titre -->
            <h1 class="font-playfair text-[42px] font-bold text-primary leading-tight mb-10">
              Personnalisez vos lunettes
            </h1>

            <!-- Formulaire -->
            <div class="space-y-7">
              
              <!-- Mat√©riau de la monture -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Mat√©riau de la monture
                </h3>
                <div class="relative">
                  <select class="select select-bordered w-full font-manrope text-sm rounded-lg bg-base-100 pr-10" id="frameMaterial">
                    <option value="">Chargement...</option>
                  </select>
                </div>
              </div>

              <!-- Couleur de la monture -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur de la monture
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #2D2926" data-color="#2D2926" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #4A5E4F" data-color="#4A5E4F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B4423" data-color="#6B4423" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D4A574" data-color="#D4A574" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #5B7B6F" data-color="#5B7B6F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8B4513" data-color="#8B4513" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A0826D" data-color="#A0826D" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #B8956F" data-color="#B8956F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #9B8B7E" data-color="#9B8B7E" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C19A6B" data-color="#C19A6B" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #704214" data-color="#704214" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A9A9A9" data-color="#A9A9A9" data-target="frame"></button>
                </div>
              </div>

              <!-- Mat√©riau des branches -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Mat√©riau des branches
                </h3>
                <div class="relative">
                  <select class="select select-bordered w-full font-manrope text-sm rounded-lg bg-base-100 pr-10" id="templeMaterial">
                    <option value="">Chargement...</option>
                  </select>
                </div>
              </div>

              <!-- Couleur des branches -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur des branches
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #2D2926" data-color="#2D2926" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #4A5E4F" data-color="#4A5E4F" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B4423" data-color="#6B4423" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C0C0C0" data-color="#C0C0C0" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #5A4A3A" data-color="#5A4A3A" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D4A574" data-color="#D4A574" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A0826D" data-color="#A0826D" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8B7355" data-color="#8B7355" data-target="temple"></button>
                </div>
              </div>

              <!-- Couleur des verres -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur des verres
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #BFBFBF" data-color="#BFBFBF" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C1999B" data-color="#C1999B" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #ABC4A1" data-color="#ABC4A1" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #2D2926" data-color="#2D2926" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8AB0C8" data-color="#8AB0C8" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D3A5A5" data-color="#D3A5A5" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #F0E68C" data-color="#F0E68C" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #808080" data-color="#808080" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #DFD7CA" data-color="#DFD7CA" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #B0A090" data-color="#B0A090" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C8BDB1" data-color="#C8BDB1" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B7C6E" data-color="#6B7C6E" data-target="lens"></button>
                </div>
              </div>

              <!-- Largeur du pont -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider">
                    Largeur du pont
                  </h3>
                  <span class="font-manrope text-xs font-semibold text-primary"><span id="bridgeValue">18</span>mm</span>
                </div>
                <input 
                  type="range" 
                  min="14" 
                  max="22" 
                  value="18" 
                  class="range range-primary range-sm w-full" 
                  id="bridgeWidth"
                />
              </div>

              <!-- Taille des verres -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider">
                    Taille des verres
                  </h3>
                  <span class="font-manrope text-xs font-semibold text-primary"><span id="lensValue">52</span>mm</span>
                </div>
                <input 
                  type="range" 
                  min="48" 
                  max="58" 
                  value="52" 
                  class="range range-primary range-sm w-full" 
                  id="lensSize"
                />
              </div>

              <!-- Nom du mod√®le -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Nom du mod√®le
                </h3>
                <input 
                  type="text" 
                  class="input input-bordered w-full rounded-lg font-manrope text-sm" 
                  placeholder="Ex: Ma paire personnalis√©e"
                  id="modelName"
                />
              </div>

              <!-- Bouton Sauvegarder -->
              <div class="pt-2">
                <button class="btn btn-primary w-full h-11 rounded-lg font-manrope font-medium text-sm normal-case shadow-sm" id="saveGlasses">
                  üíæ Sauvegarder ma paire
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Vos cr√©ations -->
      <div class="py-14 px-10 bg-base-100">
        <h2 class="font-playfair text-[32px] font-bold text-primary mb-8">
          Vos cr√©ations
        </h2>
        
        <div id="savedGlasses" class="grid grid-cols-3 gap-5 max-w-[1100px]">
          <!-- Les cartes seront ajout√©es ici dynamiquement -->
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { pb, saveLunettes, getCurrentUser, isAuthenticated } from '../lib/pocketbase';

  let rotationAngle = 0;
  let currentFrameColor = '#2D2926';
  let currentTempleColor = '#2D2926';
  let currentLensColor = '#ABC4A1';
  let currentFrameMaterial = 'acetate';
  let currentTempleMaterial = 'acetate';
  let currentBridgeWidth = 18;
  let currentLensSize = 52;

  // Canvas signature
  let isDrawing = false;
  const canvas = document.getElementById('signatureCanvas') as HTMLCanvasElement;
  const ctx = canvas?.getContext('2d');
  
  if (canvas && ctx) {
    const resizeCanvas = () => {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * 2;
      canvas.height = rect.height * 2;
      ctx.scale(2, 2);
      ctx.strokeStyle = '#1E1E1E';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    };
    resizeCanvas();

    const getPosition = (e: MouseEvent | TouchEvent) => {
      const rect = canvas.getBoundingClientRect();
      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    };

    const startDrawing = (e: MouseEvent | TouchEvent) => {
      isDrawing = true;
      const pos = getPosition(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    };

    const draw = (e: MouseEvent | TouchEvent) => {
      if (!isDrawing) return;
      const pos = getPosition(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    };

    const stopDrawing = () => { isDrawing = false; };

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', stopDrawing);

    document.getElementById('clearSignature')?.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  }

  // Charger les mat√©riaux depuis PocketBase
  async function loadMateriaux() {
    try {
      const result = await pb.collection('Materiaux').getFullList({
        sort: 'libelle',
      });

      const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
      const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;

      if (frameMaterialSelect && result) {
        frameMaterialSelect.innerHTML = '';
        result.forEach((material: any) => {
          const option = document.createElement('option');
          option.value = material.id;
          option.textContent = material.libelle;
          option.dataset.color = material.couleur || '';
          frameMaterialSelect.appendChild(option);
        });
        
        // S√©lectionner le premier par d√©faut
        if (result.length > 0) {
          currentFrameMaterial = result[0].id;
        }
      }

      if (templeMaterialSelect && result) {
        templeMaterialSelect.innerHTML = '';
        result.forEach((material: any) => {
          const option = document.createElement('option');
          option.value = material.id;
          option.textContent = material.libelle;
          option.dataset.color = material.couleur || '';
          templeMaterialSelect.appendChild(option);
        });
        
        // S√©lectionner le premier par d√©faut
        if (result.length > 0) {
          currentTempleMaterial = result[0].id;
        }
      }
    } catch (error) {
      console.error('Erreur chargement mat√©riaux:', error);
      // En cas d'erreur, afficher des options par d√©faut
      const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
      const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;
      
      const defaultOptions = [
        { value: 'acetate', label: 'Ac√©tate' },
        { value: 'metal', label: 'M√©tal' },
        { value: 'titane', label: 'Titane' },
        { value: 'bois', label: 'Bois' }
      ];

      [frameMaterialSelect, templeMaterialSelect].forEach(select => {
        if (select) {
          select.innerHTML = '';
          defaultOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });
        }
      });
    }
  }

  // Charger SVG
  async function loadSVG() {
    try {
      const response = await fetch('/lunettes.svg');
      const svgText = await response.text();
      const container = document.getElementById('svgContainer');
      if (container) {
        container.innerHTML = svgText;
        const svg = container.querySelector('svg');
        if (svg) {
          svg.style.width = '100%';
          svg.style.height = 'auto';
          applyInitialColors();
        }
      }
    } catch (error) {
      console.error('Erreur chargement SVG:', error);
    }
  }

  function applyInitialColors() {
    updateSVGColors('frame', '#2D2926');
    updateSVGColors('temple', '#2D2926');
    updateSVGColors('lens', '#ABC4A1');
  }

  function updateSVGColors(target: string, color: string) {
    const svg = document.querySelector('#svgContainer svg');
    if (!svg) return;

    if (target === 'frame') {
      const monture = svg.querySelector('#monture');
      monture?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.stroke = color;
      });
    } else if (target === 'temple') {
      const branches = svg.querySelector('#branches');
      branches?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.stroke = color;
      });
    } else if (target === 'lens') {
      const verres = svg.querySelector('#verres');
      verres?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.opacity = '0.5';
      });
    }
  }

  // Rotation
  const rotationSlider = document.getElementById('rotationSlider') as HTMLInputElement;
  const rotationDisplay = document.getElementById('rotationAngle');
  const glassPreview = document.getElementById('glassPreview');

  rotationSlider?.addEventListener('input', () => {
    const rotationAngle = parseInt(rotationSlider.value);
    if (glassPreview) glassPreview.style.transform = `rotateY(${rotationAngle}deg)`;
    if (rotationDisplay) rotationDisplay.textContent = rotationAngle.toString();
  });

  // Mat√©riaux
  document.getElementById('frameMaterial')?.addEventListener('change', (e) => {
    currentFrameMaterial = (e.target as HTMLSelectElement).value;
  });

  document.getElementById('templeMaterial')?.addEventListener('change', (e) => {
    currentTempleMaterial = (e.target as HTMLSelectElement).value;
  });

  // Couleurs
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      const color = btn.getAttribute('data-color') || '#2D2926';
      
      document.querySelectorAll(`.color-btn[data-target="${target}"]`).forEach(b => {
        b.classList.remove('ring-2', 'ring-primary', 'ring-offset-1');
      });
      btn.classList.add('ring-2', 'ring-primary', 'ring-offset-1');
      
      if (target === 'frame') currentFrameColor = color;
      else if (target === 'temple') currentTempleColor = color;
      else if (target === 'lens') currentLensColor = color;
      
      updateSVGColors(target, color);
    });
  });

  // Sliders
  document.getElementById('bridgeWidth')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    currentBridgeWidth = parseInt(value);
    const display = document.getElementById('bridgeValue');
    if (display) display.textContent = value;
  });

  document.getElementById('lensSize')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    currentLensSize = parseInt(value);
    const display = document.getElementById('lensValue');
    if (display) display.textContent = value;
  });

  // Fonction pour afficher un toast
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end z-50';
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const icon = type === 'success' ? '‚úì' : '‚úó';
    toast.innerHTML = `<div class="alert ${alertClass} shadow-lg"><span>${icon} ${message}</span></div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Sauvegarder dans PocketBase
  document.getElementById('saveGlasses')?.addEventListener('click', async () => {
    // V√©rifier si l'utilisateur est connect√©
    if (!isAuthenticated()) {
      showToast('Vous devez √™tre connect√© pour sauvegarder', 'error');
      setTimeout(() => {
        window.location.href = '/connexion';
      }, 1500);
      return;
    }

    // R√©cup√©rer les donn√©es du formulaire
    const modelNameInput = document.getElementById('modelName') as HTMLInputElement;
    const modelName = modelNameInput?.value.trim() || 'Ma paire personnalis√©e';
    
    const svgContainer = document.getElementById('svgContainer');
    const svgCode = svgContainer?.innerHTML || '';

    if (!svgCode) {
      showToast('Erreur: SVG non charg√©', 'error');
      return;
    }

    const currentUser = getCurrentUser();
    if (!currentUser) {
      showToast('Erreur: utilisateur non trouv√©', 'error');
      return;
    }

    // R√©cup√©rer les noms des mat√©riaux pour l'affichage
    const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
    const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;
    const frameMaterialName = frameMaterialSelect?.options[frameMaterialSelect.selectedIndex]?.text || 'Ac√©tate';
    const templeMaterialName = templeMaterialSelect?.options[templeMaterialSelect.selectedIndex]?.text || 'Ac√©tate';

    // Pr√©parer les donn√©es
    const glassesData = {
      nom_modele: modelName,
      svg_code: svgCode,
      largeur_pont: currentBridgeWidth,
      taille_verres: currentLensSize,
      date_creation: new Date().toISOString(),
      couleur_monture: currentFrameColor,
      couleur_branches: currentTempleColor,
      couleur_verres: currentLensColor,
      materiau_monture_nom: frameMaterialName,
      materiau_branches_nom: templeMaterialName,
      materiaux_monture: currentFrameMaterial, // ID de la relation
      materiaux_branches: currentTempleMaterial, // ID de la relation
      users: currentUser.id,
    };

    // Sauvegarder dans PocketBase
    const result = await saveLunettes(glassesData);

    if (result.success) {
      showToast('Paire sauvegard√©e avec succ√®s !', 'success');
      
      // R√©initialiser le champ nom
      if (modelNameInput) modelNameInput.value = '';
      
      // Ajouter la carte localement
      const container = document.getElementById('savedGlasses');
      if (container) {
        const card = document.createElement('div');
        card.className = 'bg-white border border-[#E5E5E5] rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = `
          <div class="h-[180px] bg-[#F5F5F5] flex items-center justify-center p-6">
            ${svgCode}
          </div>
          <div class="p-4 text-center">
            <h3 class="font-playfair text-sm font-semibold text-[#2C3E50] mb-3">
              ${modelName}
            </h3>
            <a href="/produit/${result.data?.id}" class="btn btn-ghost btn-xs w-full font-manrope text-xs normal-case">
              Voir
            </a>
          </div>
        `;
        container.prepend(card);
      }
    } else {
      showToast('Erreur lors de la sauvegarde', 'error');
      console.error('Erreur:', result.error);
    }
  });

  window.addEventListener('load', () => {
    loadSVG();
    loadMateriaux();
  });

  // ============ G√âN√âRATION IA ============

  let promptHistory: Array<{role: string, content: string}> = [];
  
  const aiPromptInput = document.getElementById('aiPrompt') as HTMLTextAreaElement;
  const generateBtn = document.getElementById('generateBtn') as HTMLButtonElement;
  const editBtn = document.getElementById('editBtn') as HTMLButtonElement;
  const aiAlert = document.getElementById('aiAlert') as HTMLDivElement;

  function showAIAlert(type: 'info' | 'success' | 'error' | 'warning', message: string) {
    aiAlert.className = `alert alert-${type} text-sm font-manrope`;
    aiAlert.textContent = message;
    aiAlert.classList.remove('hidden');
  }

  function hideAIAlert() {
    aiAlert.classList.add('hidden');
  }

  async function callGenerateGlasses(messages: Array<{role: string, content: string}>) {
    console.log('callGenerateGlasses called with messages:', messages);
    const bodyData = { messages };
    console.log('Body data to send:', bodyData);
    console.log('Body JSON:', JSON.stringify(bodyData));
    
    const res = await fetch('/api/generateGlasses', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyData),
    });
    const data = await res.json(); // { svg: {role, content} } ou {error}
    if (!res.ok) throw new Error(data?.error || 'Erreur API');
    return data.svg; // {role:'assistant', content:'<svg...'}
  }

  async function handleGenerate() {
    const prompt = aiPromptInput.value.trim();
    if (!prompt) {
      showAIAlert('warning', 'D√©crivez d\'abord votre paire de lunettes.');
      return;
    }

    showAIAlert('info', 'üé® G√©n√©ration en cours...');
    generateBtn.disabled = true;
    editBtn.disabled = true;

    try {
      // R√©initialiser l'historique
      promptHistory = [];
      promptHistory.push({ role: 'user', content: prompt });

      const aiMsg = await callGenerateGlasses(promptHistory);
      const match = aiMsg.content.match(/<svg[\s\S]*?<\/svg>/i);
      aiMsg.content = match ? match[0] : '';

      if (!aiMsg.content) {
        throw new Error('Aucun SVG g√©n√©r√©');
      }

      promptHistory.push(aiMsg);

      // Injecter le SVG dans le preview
      const svgContainer = document.getElementById('svgContainer');
      if (svgContainer) {
        svgContainer.innerHTML = aiMsg.content;
        
        // Mettre √† jour les couleurs avec les valeurs actuelles
        const svg = svgContainer.querySelector('svg');
        if (svg) {
          applyCurrentColors(svg);
        }
      }

      showAIAlert('success', '‚úÖ Lunettes g√©n√©r√©es ! Vous pouvez maintenant les personnaliser.');
      editBtn.disabled = false;
      
      // Vider le champ pour la prochaine modification
      aiPromptInput.value = '';
    } catch (e: any) {
      console.error(e);
      showAIAlert('error', e.message || 'Erreur lors de la g√©n√©ration');
    } finally {
      generateBtn.disabled = false;
    }
  }

  async function handleEdit() {
    const prompt = aiPromptInput.value.trim();
    if (!prompt) {
      showAIAlert('warning', 'D√©crivez les modifications souhait√©es.');
      return;
    }

    showAIAlert('info', '‚úèÔ∏è Modification en cours...');
    generateBtn.disabled = true;
    editBtn.disabled = true;

    try {
      promptHistory.push({ role: 'user', content: prompt });

      const aiMsg = await callGenerateGlasses(promptHistory);
      const match = aiMsg.content.match(/<svg[\s\S]*?<\/svg>/i);
      aiMsg.content = match ? match[0] : '';

      if (!aiMsg.content) {
        throw new Error('Aucun SVG g√©n√©r√©');
      }

      promptHistory.push(aiMsg);

      // Injecter le SVG
      const svgContainer = document.getElementById('svgContainer');
      if (svgContainer) {
        svgContainer.innerHTML = aiMsg.content;
        
        // Appliquer les couleurs actuelles
        const svg = svgContainer.querySelector('svg');
        if (svg) {
          applyCurrentColors(svg);
        }
      }

      showAIAlert('success', '‚úÖ Lunettes modifi√©es !');
      
      // Vider le champ
      aiPromptInput.value = '';
    } catch (e: any) {
      console.error(e);
      showAIAlert('error', e.message || 'Erreur lors de la modification');
    } finally {
      generateBtn.disabled = false;
      editBtn.disabled = false;
    }
  }

  // Fonction pour appliquer les couleurs actuelles au SVG g√©n√©r√©
  function applyCurrentColors(svg: SVGElement) {
    // Appliquer les couleurs de monture
    const frameElements = svg.querySelectorAll('[id*="frame"], [id*="bridge"]');
    frameElements.forEach(el => {
      (el as SVGElement).style.fill = currentFrameColor;
      (el as SVGElement).style.stroke = currentFrameColor;
    });

    // Appliquer les couleurs de branches
    const templeElements = svg.querySelectorAll('[id*="temple"]');
    templeElements.forEach(el => {
      (el as SVGElement).style.fill = currentTempleColor;
      (el as SVGElement).style.stroke = currentTempleColor;
    });

    // Appliquer les couleurs de verres
    const lensElements = svg.querySelectorAll('[id*="lens"]');
    lensElements.forEach(el => {
      (el as SVGElement).style.fill = currentLensColor;
      (el as SVGElement).style.opacity = '0.3';
    });
  }

  generateBtn?.addEventListener('click', handleGenerate);
  editBtn?.addEventListener('click', handleEdit);
</script>
