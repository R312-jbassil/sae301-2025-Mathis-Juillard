---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Personnalisation - TaVue">
  <div class="bg-base-100">
    <div class="max-w-[1920px] mx-auto">
      <!-- Grille 2 colonnes -->
      <div class="grid grid-cols-2 min-h-screen">
        
        <!-- Colonne gauche : Preview fixe -->
        <div class="bg-base-200 flex flex-col justify-between sticky top-0 h-screen p-12">
          <!-- SVG Preview + Rotation -->
          <div class="flex-1 flex flex-col justify-center items-center">
            <div class="w-full max-w-[480px] mb-8" style="perspective: 1200px;">
              <div id="glassPreview" class="transition-transform duration-500" style="transform-style: preserve-3d;">
                <div id="svgContainer"></div>
              </div>
            </div>

            <!-- Slider rotation -->
            <div class="w-full max-w-[480px]">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-manrope font-medium text-base-content">Rotation</span>
                <span class="text-xs font-manrope font-semibold text-primary"><span id="rotationAngle">0</span>°</span>
              </div>
              <input 
                type="range" 
                min="-180" 
                max="180" 
                value="0"
                step="5"
                class="range range-primary range-sm w-full" 
                id="rotationSlider"
              />
            </div>
          </div>

          <!-- Citation décalée en bas -->
          <div class="w-[320px] ml-auto mr-8">
            <p class="font-playfair text-[16px] italic text-base-content/70 leading-relaxed text-right">
              Votre regard,<br/>
              <span class="font-bold text-secondary text-[18px] not-italic">VOTRE CRÉATION</span>
            </p>
          </div>
        </div>

        <!-- Colonne droite : Formulaire -->
        <div class="py-12 px-10">
          <div class="max-w-[560px]">
            <!-- Titre -->
            <h1 class="font-playfair text-[42px] font-bold text-primary leading-tight mb-10">
              Personnalisez vos lunettes
            </h1>

            <!-- Formulaire -->
            <div class="space-y-7">
              
              <!-- Matériau de la monture -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Matériau de la monture
                </h3>
                <div class="relative">
                  <select class="select select-bordered w-full font-manrope text-sm rounded-lg bg-base-100 pr-10" id="frameMaterial">
                    <option value="">Chargement...</option>
                  </select>
                </div>
              </div>

              <!-- Couleur de la monture -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur de la monture
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #2D2926" data-color="#2D2926" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #4A5E4F" data-color="#4A5E4F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B4423" data-color="#6B4423" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D4A574" data-color="#D4A574" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #5B7B6F" data-color="#5B7B6F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8B4513" data-color="#8B4513" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A0826D" data-color="#A0826D" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #B8956F" data-color="#B8956F" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #9B8B7E" data-color="#9B8B7E" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C19A6B" data-color="#C19A6B" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #704214" data-color="#704214" data-target="frame"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A9A9A9" data-color="#A9A9A9" data-target="frame"></button>
                </div>
              </div>

              <!-- Matériau des branches -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Matériau des branches
                </h3>
                <div class="relative">
                  <select class="select select-bordered w-full font-manrope text-sm rounded-lg bg-base-100 pr-10" id="templeMaterial">
                    <option value="">Chargement...</option>
                  </select>
                </div>
              </div>

              <!-- Couleur des branches -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur des branches
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #2D2926" data-color="#2D2926" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #4A5E4F" data-color="#4A5E4F" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B4423" data-color="#6B4423" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C0C0C0" data-color="#C0C0C0" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #5A4A3A" data-color="#5A4A3A" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D4A574" data-color="#D4A574" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #A0826D" data-color="#A0826D" data-target="temple"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8B7355" data-color="#8B7355" data-target="temple"></button>
                </div>
              </div>

              <!-- Couleur des verres -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Couleur des verres
                </h3>
                <div class="grid grid-cols-6 gap-2">
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #BFBFBF" data-color="#BFBFBF" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C1999B" data-color="#C1999B" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn ring-2 ring-primary ring-offset-1" style="background: #ABC4A1" data-color="#ABC4A1" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #2D2926" data-color="#2D2926" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #8AB0C8" data-color="#8AB0C8" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #D3A5A5" data-color="#D3A5A5" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #F0E68C" data-color="#F0E68C" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #808080" data-color="#808080" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #DFD7CA" data-color="#DFD7CA" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #B0A090" data-color="#B0A090" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #C8BDB1" data-color="#C8BDB1" data-target="lens"></button>
                  <button class="w-10 h-10 rounded-md border-2 border-base-300 hover:border-primary transition-all color-btn" style="background: #6B7C6E" data-color="#6B7C6E" data-target="lens"></button>
                </div>
              </div>

              <!-- Largeur du pont -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider">
                    Largeur du pont
                  </h3>
                  <span class="font-manrope text-xs font-semibold text-primary"><span id="bridgeValue">18</span>mm</span>
                </div>
                <input 
                  type="range" 
                  min="14" 
                  max="22" 
                  value="18" 
                  class="range range-primary range-sm w-full" 
                  id="bridgeWidth"
                />
              </div>

              <!-- Taille des verres -->
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider">
                    Taille des verres
                  </h3>
                  <span class="font-manrope text-xs font-semibold text-primary"><span id="lensValue">52</span>mm</span>
                </div>
                <input 
                  type="range" 
                  min="48" 
                  max="58" 
                  value="52" 
                  class="range range-primary range-sm w-full" 
                  id="lensSize"
                />
              </div>

              <!-- Description -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Décrivez vos lunettes
                </h3>
                <textarea 
                  class="textarea textarea-bordered w-full rounded-lg h-24 font-manrope text-xs resize-none" 
                  placeholder="Ici, écrivez la description de vos lunettes pour que l'IA puisse les générer"
                  id="description"
                ></textarea>
              </div>

              <!-- Nom du modèle -->
              <div>
                <h3 class="font-manrope text-[11px] font-semibold text-base-content uppercase tracking-wider mb-3">
                  Nom du modèle
                </h3>
                <input 
                  type="text" 
                  class="input input-bordered w-full rounded-lg font-manrope text-sm" 
                  placeholder="Ex: Ma paire personnalisée"
                  id="modelName"
                />
              </div>

              <!-- Boutons -->
              <div class="grid grid-cols-2 gap-4 pt-2">
                <button class="btn bg-secondary hover:bg-secondary/90 text-secondary-content border-0 h-11 rounded-lg font-manrope font-medium text-xs normal-case shadow-sm">
                  Générer avec l'IA
                </button>
                <button class="btn bg-[#2C3E50] hover:bg-[#2C3E50]/90 text-white border-0 h-11 rounded-lg font-manrope font-medium text-sm normal-case shadow-sm" id="saveGlasses">
                  Sauvegarder ma paire
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Vos créations -->
      <div class="py-14 px-10 bg-base-100">
        <h2 class="font-playfair text-[32px] font-bold text-primary mb-8">
          Vos créations
        </h2>
        
        <div id="savedGlasses" class="grid grid-cols-3 gap-5 max-w-[1100px]">
          <!-- Les cartes seront ajoutées ici dynamiquement -->
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { pb, saveLunettes, getCurrentUser, isAuthenticated } from '../lib/pocketbase';

  let rotationAngle = 0;
  let currentFrameColor = '#2D2926';
  let currentTempleColor = '#2D2926';
  let currentLensColor = '#ABC4A1';
  let currentFrameMaterial = 'acetate';
  let currentTempleMaterial = 'acetate';
  let currentBridgeWidth = 18;
  let currentLensSize = 52;

  // Canvas signature
  let isDrawing = false;
  const canvas = document.getElementById('signatureCanvas') as HTMLCanvasElement;
  const ctx = canvas?.getContext('2d');
  
  if (canvas && ctx) {
    const resizeCanvas = () => {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * 2;
      canvas.height = rect.height * 2;
      ctx.scale(2, 2);
      ctx.strokeStyle = '#1E1E1E';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    };
    resizeCanvas();

    const getPosition = (e: MouseEvent | TouchEvent) => {
      const rect = canvas.getBoundingClientRect();
      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    };

    const startDrawing = (e: MouseEvent | TouchEvent) => {
      isDrawing = true;
      const pos = getPosition(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    };

    const draw = (e: MouseEvent | TouchEvent) => {
      if (!isDrawing) return;
      const pos = getPosition(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    };

    const stopDrawing = () => { isDrawing = false; };

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseleave', stopDrawing);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', stopDrawing);

    document.getElementById('clearSignature')?.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  }

  // Charger les matériaux depuis PocketBase
  async function loadMateriaux() {
    try {
      const result = await pb.collection('Materiaux').getFullList({
        sort: 'libelle',
      });

      const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
      const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;

      if (frameMaterialSelect && result) {
        frameMaterialSelect.innerHTML = '';
        result.forEach((material: any) => {
          const option = document.createElement('option');
          option.value = material.id;
          option.textContent = material.libelle;
          option.dataset.color = material.couleur || '';
          frameMaterialSelect.appendChild(option);
        });
        
        // Sélectionner le premier par défaut
        if (result.length > 0) {
          currentFrameMaterial = result[0].id;
        }
      }

      if (templeMaterialSelect && result) {
        templeMaterialSelect.innerHTML = '';
        result.forEach((material: any) => {
          const option = document.createElement('option');
          option.value = material.id;
          option.textContent = material.libelle;
          option.dataset.color = material.couleur || '';
          templeMaterialSelect.appendChild(option);
        });
        
        // Sélectionner le premier par défaut
        if (result.length > 0) {
          currentTempleMaterial = result[0].id;
        }
      }
    } catch (error) {
      console.error('Erreur chargement matériaux:', error);
      // En cas d'erreur, afficher des options par défaut
      const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
      const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;
      
      const defaultOptions = [
        { value: 'acetate', label: 'Acétate' },
        { value: 'metal', label: 'Métal' },
        { value: 'titane', label: 'Titane' },
        { value: 'bois', label: 'Bois' }
      ];

      [frameMaterialSelect, templeMaterialSelect].forEach(select => {
        if (select) {
          select.innerHTML = '';
          defaultOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
          });
        }
      });
    }
  }

  // Charger SVG
  async function loadSVG() {
    try {
      const response = await fetch('/lunettes.svg');
      const svgText = await response.text();
      const container = document.getElementById('svgContainer');
      if (container) {
        container.innerHTML = svgText;
        const svg = container.querySelector('svg');
        if (svg) {
          svg.style.width = '100%';
          svg.style.height = 'auto';
          applyInitialColors();
        }
      }
    } catch (error) {
      console.error('Erreur chargement SVG:', error);
    }
  }

  function applyInitialColors() {
    updateSVGColors('frame', '#2D2926');
    updateSVGColors('temple', '#2D2926');
    updateSVGColors('lens', '#ABC4A1');
  }

  function updateSVGColors(target: string, color: string) {
    const svg = document.querySelector('#svgContainer svg');
    if (!svg) return;

    if (target === 'frame') {
      const monture = svg.querySelector('#monture');
      monture?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.stroke = color;
      });
    } else if (target === 'temple') {
      const branches = svg.querySelector('#branches');
      branches?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.stroke = color;
      });
    } else if (target === 'lens') {
      const verres = svg.querySelector('#verres');
      verres?.querySelectorAll('path').forEach((el: SVGElement) => {
        el.style.fill = color;
        el.style.opacity = '0.5';
      });
    }
  }

  // Rotation
  const rotationSlider = document.getElementById('rotationSlider') as HTMLInputElement;
  const rotationDisplay = document.getElementById('rotationAngle');
  const glassPreview = document.getElementById('glassPreview');

  rotationSlider?.addEventListener('input', () => {
    const rotationAngle = parseInt(rotationSlider.value);
    if (glassPreview) glassPreview.style.transform = `rotateY(${rotationAngle}deg)`;
    if (rotationDisplay) rotationDisplay.textContent = rotationAngle.toString();
  });

  // Matériaux
  document.getElementById('frameMaterial')?.addEventListener('change', (e) => {
    currentFrameMaterial = (e.target as HTMLSelectElement).value;
  });

  document.getElementById('templeMaterial')?.addEventListener('change', (e) => {
    currentTempleMaterial = (e.target as HTMLSelectElement).value;
  });

  // Couleurs
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      const color = btn.getAttribute('data-color') || '#2D2926';
      
      document.querySelectorAll(`.color-btn[data-target="${target}"]`).forEach(b => {
        b.classList.remove('ring-2', 'ring-primary', 'ring-offset-1');
      });
      btn.classList.add('ring-2', 'ring-primary', 'ring-offset-1');
      
      if (target === 'frame') currentFrameColor = color;
      else if (target === 'temple') currentTempleColor = color;
      else if (target === 'lens') currentLensColor = color;
      
      updateSVGColors(target, color);
    });
  });

  // Sliders
  document.getElementById('bridgeWidth')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    currentBridgeWidth = parseInt(value);
    const display = document.getElementById('bridgeValue');
    if (display) display.textContent = value;
  });

  document.getElementById('lensSize')?.addEventListener('input', (e) => {
    const value = (e.target as HTMLInputElement).value;
    currentLensSize = parseInt(value);
    const display = document.getElementById('lensValue');
    if (display) display.textContent = value;
  });

  // Fonction pour afficher un toast
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end z-50';
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const icon = type === 'success' ? '✓' : '✗';
    toast.innerHTML = `<div class="alert ${alertClass} shadow-lg"><span>${icon} ${message}</span></div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Sauvegarder dans PocketBase
  document.getElementById('saveGlasses')?.addEventListener('click', async () => {
    // Vérifier si l'utilisateur est connecté
    if (!isAuthenticated()) {
      showToast('Vous devez être connecté pour sauvegarder', 'error');
      setTimeout(() => {
        window.location.href = '/connexion';
      }, 1500);
      return;
    }

    // Récupérer les données du formulaire
    const modelNameInput = document.getElementById('modelName') as HTMLInputElement;
    const modelName = modelNameInput?.value.trim() || 'Ma paire personnalisée';
    
    const svgContainer = document.getElementById('svgContainer');
    const svgCode = svgContainer?.innerHTML || '';

    if (!svgCode) {
      showToast('Erreur: SVG non chargé', 'error');
      return;
    }

    const currentUser = getCurrentUser();
    if (!currentUser) {
      showToast('Erreur: utilisateur non trouvé', 'error');
      return;
    }

    // Récupérer les noms des matériaux pour l'affichage
    const frameMaterialSelect = document.getElementById('frameMaterial') as HTMLSelectElement;
    const templeMaterialSelect = document.getElementById('templeMaterial') as HTMLSelectElement;
    const frameMaterialName = frameMaterialSelect?.options[frameMaterialSelect.selectedIndex]?.text || 'Acétate';
    const templeMaterialName = templeMaterialSelect?.options[templeMaterialSelect.selectedIndex]?.text || 'Acétate';

    // Préparer les données
    const glassesData = {
      nom_modele: modelName,
      svg_code: svgCode,
      largeur_pont: currentBridgeWidth,
      taille_verres: currentLensSize,
      date_creation: new Date().toISOString(),
      couleur_monture: currentFrameColor,
      couleur_branches: currentTempleColor,
      couleur_verres: currentLensColor,
      materiau_monture_nom: frameMaterialName,
      materiau_branches_nom: templeMaterialName,
      materiaux_monture: currentFrameMaterial, // ID de la relation
      materiaux_branches: currentTempleMaterial, // ID de la relation
      users: currentUser.id,
    };

    // Sauvegarder dans PocketBase
    const result = await saveLunettes(glassesData);

    if (result.success) {
      showToast('Paire sauvegardée avec succès !', 'success');
      
      // Réinitialiser le champ nom
      if (modelNameInput) modelNameInput.value = '';
      
      // Ajouter la carte localement
      const container = document.getElementById('savedGlasses');
      if (container) {
        const card = document.createElement('div');
        card.className = 'bg-white border border-[#E5E5E5] rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = `
          <div class="h-[180px] bg-[#F5F5F5] flex items-center justify-center p-6">
            ${svgCode}
          </div>
          <div class="p-4 text-center">
            <h3 class="font-playfair text-sm font-semibold text-[#2C3E50] mb-3">
              ${modelName}
            </h3>
            <a href="/produit/${result.data?.id}" class="btn btn-ghost btn-xs w-full font-manrope text-xs normal-case">
              Voir
            </a>
          </div>
        `;
        container.prepend(card);
      }
    } else {
      showToast('Erreur lors de la sauvegarde', 'error');
      console.error('Erreur:', result.error);
    }
  });

  window.addEventListener('load', () => {
    loadSVG();
    loadMateriaux();
  });
</script>
