---
import '../styles/global.css';

interface Props {
  title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="fr" data-theme="tavue">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/assets/logo.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>{title}</title>
  </head>
  <body>
    <!-- Header -->
    <header class="bg-base-100 border-b border-base-300">
      <nav class="container mx-auto px-6 lg:px-12 py-5">
        <div class="flex items-center justify-between">
          <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
            <img src="/logo.webp" alt="TaVue Logo" class="h-8 w-auto" />
          </a>
          
          <ul class="hidden md:flex items-center gap-10">
            <li>
              <a 
                href="/personnalisation" 
                class={`text-sm font-medium transition-colors hover:text-primary ${currentPath === '/personnalisation' ? 'text-primary underline underline-offset-4' : 'text-base-content'}`}
              >
                Personnalisation
              </a>
            </li>
            <li>
              <a 
                href="/mes-lunettes" 
                class={`text-sm font-medium transition-colors hover:text-primary ${currentPath === '/mes-lunettes' ? 'text-primary underline underline-offset-4' : 'text-base-content'}`}
              >
                Mes lunettes
              </a>
            </li>
            <li id="authSection">
              <a 
                href="/connexion" 
                id="authLink"
                class={`text-sm font-medium transition-colors hover:text-primary ${currentPath === '/connexion' ? 'text-primary underline underline-offset-4' : 'text-base-content'}`}
              >
                Mon compte
              </a>
            </li>
            <li>
              <a href="/panier" class="btn btn-ghost btn-circle relative" id="cartButton">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span id="cartCount" class="hidden absolute -top-1 -right-1 bg-error text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center animate-bounce">
                  0
                </span>
              </a>
            </li>
          </ul>

          <!-- Mobile menu button -->
          <button class="md:hidden btn btn-ghost btn-square btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-5 h-5 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main>
      <slot />
    </main>

    <!-- Footer -->
    <footer class="bg-base-100 border-t border-base-300 mt-32">
      <div class="container mx-auto px-6 lg:px-12 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-8">
          <div class="text-center md:text-left">
            <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
              <img src="/logo.webp" alt="TaVue Logo" class="h-6 w-auto" />
            </a>
          </div>
          
          <ul class="flex items-center gap-8 text-sm">
            <li><a href="/personnalisation" class="hover:text-primary transition-colors">Personnalisation</a></li>
            <li><a href="/produit" class="hover:text-primary transition-colors">Produit</a></li>
            <li><a href="/panier" class="hover:text-primary transition-colors">Panier</a></li>
            <li><a href="/contact" class="hover:text-primary transition-colors">Contact</a></li>
          </ul>
          
          <p class="text-sm text-base-content/60">&copy; {new Date().getFullYear()} TaVue</p>
        </div>
      </div>
    </footer>

    <script>
      import { isAuthenticated, getCurrentUser, logout } from '../lib/pocketbase';

      // Gestion du compteur panier
      document.addEventListener('cart:updated', ((e: CustomEvent) => {
        const cartCount = document.getElementById('cartCount');
        const count = e.detail.count;
        
        if (cartCount) {
          if (count > 0) {
            cartCount.textContent = count.toString();
            cartCount.classList.remove('hidden');
            cartCount.classList.add('animate-bounce');
            setTimeout(() => cartCount.classList.remove('animate-bounce'), 1000);
          } else {
            cartCount.classList.add('hidden');
          }
        }
      }) as EventListener);

      // Gestion de l'authentification dans le header
      document.addEventListener('DOMContentLoaded', () => {
        const authSection = document.getElementById('authSection');
        const authLink = document.getElementById('authLink');

        if (isAuthenticated()) {
          const user = getCurrentUser();
          if (authLink && user) {
            // Remplacer par un menu utilisateur
            authSection!.innerHTML = `
              <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-sm normal-case">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span class="ml-2">${user.nom || user.email}</span>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 mt-4">
                  <li><a href="/mes-lunettes">Mes lunettes</a></li>
                  <li><a href="/personnalisation">Personnaliser</a></li>
                  <li><a href="/panier">Mon panier</a></li>
                  <li class="border-t mt-2 pt-2"><a id="logoutBtn">Déconnexion</a></li>
                </ul>
              </div>
            `;

            // Ajouter l'événement de déconnexion
            setTimeout(() => {
              const logoutBtn = document.getElementById('logoutBtn');
              logoutBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
                window.location.href = '/';
              });
            }, 100);
          }
        }
      });
    </script>
  </body>
</html>
